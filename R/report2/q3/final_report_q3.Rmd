---
title: "PAWS - Volunteer disengagement"
author: "R-Ladies Philadelphia, Alice Walsh (re-run & modified by KF)"
date: "8/20/2018"
output:
  pdf_document: default
  html_document: default
---

```{r, echo=FALSE, include=FALSE}
rm(list = ls()) # can modify this if we are passing parameters into rmarkdown, etc.
set.seed(1234)
options(stringsAsFactors = FALSE)
```

```{r setup, include=FALSE}
# Here I set for graphs to save to pdf so others can use
knitr::opts_chunk$set(echo = FALSE,
                      dev = 'pdf',
                      fig.path = 'final_plots/')
```

```{r load_libs, warning=FALSE, message=FALSE, include = FALSE}
library(survival)
library(survminer)
library(RColorBrewer)
suppressPackageStartupMessages(library(tidyverse))
library(ggalluvial)
```

```{r additional_setup, include=FALSE}
# I like to change the default color palette - doesn't apply to ggsurvplot for some reason?
scale_color_discrete <- function(...) {scale_color_manual(..., values = brewer.pal(n=9, name = "Set1"))}
scale_fill_discrete <- function(...) {scale_fill_manual(..., values = brewer.pal(n=9, name = "Set1"))}

```

# Question
What is the typical pattern for volunteer disengagement?

First, I summarised the number of volunteers with various characteristics:  

* did orientation, but no shifts
* did orientation, had only 1 shift
* did orientation, had 2+ shifts

How do we define a "disengaged" volunteer?  

* For the purpose of this analysis, we considered a volunteer was disengaged (i.e., stopped volunteering) if the length of time after their last shift was > 90 days ago. This was based on both common sense - 3 months since last volunteering is a long time, and also the distribution of the data.

# Procedure  

1. Load in the data that was pre-cleaned and merged
1. Analyze and create plots

All analysis was performed for volunteers that did orientation between Jan 01 and May 01.

* 2017: Orientation (primary) between Jan 01 2017 - May 01 2017
* 2018: Orientation (primary) between Jan 01 2018 - May 01 2018


```{r load_data}
final_data <- readRDS("../../../Data/merged.Rds")
```

# Analysis

## Summary of volunteers

* How many did orientation, but no shifts?
* How many did orientation, had only 1 shift?
* How many did orientation, had 2+ shifts?

```{r summarise, warning=FALSE}
final_data_filt <- final_data %>%
  filter(Orientation.Date.Primary >= "2017-01-01", Orientation.Date.Primary < "2018-05-01")

end_summary <- final_data_filt  %>%
  group_by(test_period) %>% 
  summarise(total_volunteers = n(),
            `no service` = paste( round(100* sum(total_shifts==0)/n(),1) ,"%"),
            `only 1 shift` = paste( round(100* sum(total_shifts==1)/n(),1),"%"),
            `2-9 shifts` = paste( round(100* sum(total_shifts>=2 & total_shifts<10)/n(), 1), "%"),
            `10+ shifts` = paste( round(100* sum(total_shifts>=10)/n(), 1), "%"),
            ave_shifts = round( mean(total_shifts), 2),
            ave_missed_shifts = round( mean(missed_shifts), 2))

knitr::kable(t(end_summary), caption="Overall Summary")

```

Even though we have data for all of 2017, and only until July 26, 2018, we see that the volunteers from 2018 are doing comparably.

## Summary of volunteers by site where they did orientation
```{r summarise_loc}

loc_summary_2017 <- final_data_filt  %>%
  filter(test_period == "2017") %>% 
  group_by(orient_loc.Primary) %>%
  summarise(total_volunteers = n(),
           `no service` = sum(total_shifts==0) ,
            `1 shift` = sum(total_shifts==1),
            `2-9 shifts` = sum(twoplus_shifts==TRUE),
            `10+ shifts` = sum(tenplus_shifts==TRUE))
loc_summary_2017 <- t(loc_summary_2017)
colnames(loc_summary_2017) <- loc_summary_2017[1,]
loc_summary_2017 <- loc_summary_2017[-1,]
# This is not good code...
loc_summary <- final_data_filt  %>%
  filter(test_period == "2018") %>% 
  group_by(orient_loc.Primary) %>%
  summarise(total_volunteers = n(),
           `no service` = sum(total_shifts==0) ,
            `1 shift` = sum(total_shifts==1),
            `2-9 shifts` = sum(twoplus_shifts==TRUE),
            `10+ shifts` = sum(tenplus_shifts==TRUE))
loc_summary <- t(loc_summary)
colnames(loc_summary) <- loc_summary[1,]
loc_summary <- loc_summary[-1,]
knitr::kable(loc_summary, caption="Summary stratified by location, 2018")

```

```{r loc_plot}

# reshape data for plot
d <- as.data.frame(loc_summary) %>% 
  rownames_to_column("label") %>% 
  filter(label != "total_volunteers") %>% 
  gather(key = "site", value = "value", GF:PAC) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(site) %>% 
  mutate(percent =paste(round(100* value / sum(value), 2), "%"),
         year = "2018")

d2017 <- as.data.frame(loc_summary_2017) %>% 
  rownames_to_column("label") %>% 
  filter(label != "total_volunteers") %>% 
  gather(key = "site", value = "value", GF:PAC) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(site) %>% 
  mutate(percent =paste(round(100* value / sum(value), 2), "%"),
         year = "2017")

d <- rbind(d,d2017)
d$label <- factor(d$label, levels = c("no service", "1 shift", "2-9 shifts", "10+ shifts"))

g <- ggplot(d, aes(x = site, y= value, fill=label, label=percent)) + 
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = 12) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) + 
  ylab("Number of volunteers") + 
  facet_wrap(~year) + 
  theme_bw() + 
  ggtitle("Number of new volunteers by service level, per location\nJan - May")

g
png("Engagement_by_ShiftCount_2018.png", width=800, height=600)
g
dev.off()
```

## Summary of volunteer disengagement
```{r}
med_days <- median(filter(final_data_filt, 
                          total_shifts > 0, 
                          test_period == "2018")$days_since_last)
med_days_between <- median(filter(final_data_filt, 
                                  total_shifts > 0,
                                  test_period == "2018")$time_bw_shifts, na.rm = T)

```

For a new volunteer in 2018 that did at least one shift:

The median days since last shift is `r med_days` days.

The median time between shifts is `r med_days_between` days.


```{r calc_disengage}
final_data_filt$event <- 0
final_data_filt$event[final_data_filt$days_since_last > 90] <- 1 

# create factor for whether they reported for shift within 14 days
final_data_filt$first_shift_group <- case_when(
  as.numeric(final_data_filt$time_to_first) <= 14 ~ "<= 14 days",
  as.numeric(final_data_filt$time_to_first) <= 60 ~ "14 to 60 days",
  as.numeric(final_data_filt$time_to_first) > 60 ~ "> 60 days"
)
final_data_filt$first_shift_group <- factor(final_data_filt$first_shift_group,
                                       levels = c("<= 14 days",
                                                  "14 to 60 days", 
                                                  "> 60 days"))

final_data_filt$timebw_shift_group <- case_when(
  as.numeric(final_data_filt$time_bw_median) <= 7 ~ "<= 7 days",
  as.numeric(final_data_filt$time_bw_median) <= 14 ~ "7 to 14 days",
  as.numeric(final_data_filt$time_bw_median) > 14 ~ "> 14 days"
)
final_data_filt$timebw_shift_group <- factor(final_data_filt$timebw_shift_group, 
                                        levels = c("<= 7 days", "7 to 14 days", "> 14 days"))

final_data_filt %>%
  filter(total_shifts > 0) %>%
  group_by(first_shift_group) %>%
  summarise(mean_shifts = mean(total_shifts),
            mean_missed_shifts = mean(missed_shifts),
            freq = n()) %>%
  knitr::kable(caption = "Summary of time between orientation to the first shift")

final_data_filt %>%
  filter(total_shifts > 0 ) %>%
  group_by(timebw_shift_group) %>%
  summarise(mean_shifts = mean(total_shifts),
            mean_missed_shifts = mean(missed_shifts),
            freq = n()) %>%
  knitr::kable(caption = "Summary of time between shifts")
```

## Visualizations
In the below histogram, we see that most the engaged volunteers have volunteered in the last 90 days (vertical black line), while the disengaged volunteers have not volunteered in 100 or more days.


```{r days_since_last}
ggplot(filter(final_data_filt, total_shifts > 0, test_period != "other"), 
       aes(x= days_since_last)) + 
  geom_histogram(binwidth = 7) + 
  geom_vline(xintercept = 90) + 
  ylab("Number of Volunteers") + 
  xlab("Days since last shift") + 
  ggtitle("Days since last shift") + 
  facet_wrap(~test_period) + 
  theme_bw()

```


```{r alluvial_plot, include=FALSE, eval = FALSE}
signup_service_plot <- final_data_filt %>%
  filter(total_shifts > 0 ) %>%
  mutate(event = factor(event)) %>%
  group_by(event, orient_loc.Primary, primary_type) %>%
  summarise(Freq = n()) %>%
  ungroup()


ggplot(data = signup_service_plot,
       aes(axis1 = orient_loc.Primary, axis2 = primary_type,
           weight = Freq)) +
  scale_x_discrete(limits = c("Primary Orientation Location", "Type"), expand = c(.1, .05)) +
  geom_alluvium(aes(fill = event)) +
  geom_stratum() + geom_text(stat = "stratum", label.strata = TRUE) +
  theme_minimal() +
  ggtitle("PAWS Volunteer patterns",
          "stratified by whether they became disengaged")
```


## Plot volunteers time between first shift and disengagement

```{r kaplan-meier_timetofirst, fig.width=8, fig.height=6}
model_data <- filter(final_data_filt, total_shifts > 0, test_period == "2018")
surv.model <- Surv(model_data$time_last_to_first, model_data$event)

surv.fit <- survfit(surv.model ~ first_shift_group + test_period, data = model_data)

ggsurvplot(surv.fit, data = model_data,
           surv.median.line = "hv", 
           pval = TRUE, conf.int = TRUE, cumevents = TRUE,
           ylab = "Volunteer Engagement Prob",
           palette = brewer.pal(n=9, "Set1"),
           xlab = "Time From First to Last Shift (days)",
           title = "Compare time between orientation and first shift, data in 2018",
           legend.title = "", 
           legend.labs = levels(factor(model_data$first_shift_group)))


```


We do not observe a significant relationship between the delay between orientation and volunteering and how long the volunteer continues to volunteer. 

The median volunteer engangement time was not yet reached.

```{r kaplan-meier_timebetween, fig.width=8, fig.height=6}
surv.fit <- survfit(surv.model ~ timebw_shift_group, data = model_data)

ggsurvplot(surv.fit, data = model_data,
           surv.median.line = "hv", 
           pval = TRUE, conf.int = TRUE, cumevents = TRUE,
           ylab = "Volunteer Engagement Prob",
           palette = brewer.pal(n=9, "Set1"),
           xlab = "Time From First to Last Shift (days)",
           title = "Compare median time between shifts, data in 2018",
           legend.title = "", legend.labs = levels(factor(model_data$timebw_shift_group)))  

```

We don't see a strong trend that volunteers leave sooner if they tend to volunteer more or less frequently.

The median volunteer engangement time was not yet reached.


```{r kaplan-meier-only-one, fig.width=8, fig.height=6}
# Could plot either total_time - time from orientation to last shift
# or time_last_to_first - time from first shift to last shift

model_data <- filter(final_data_filt, total_shifts > 0, test_period == "2018")
surv.model <- Surv(model_data$total_time, model_data$event)
surv.fit <- survfit(surv.model ~ only_one_shift, data = model_data)
# surv.fit
# ggsurvplot(surv.fit, data = model_data,
#            surv.median.line = "hv", 
#            pval = TRUE, conf.int = TRUE, cumevents = TRUE,
#            ylab = "Volunteer Engagement Prob",
#            palette = brewer.pal(n=9, "Set1"),
#            xlab = "Time From Orientation to Last Shift (days)",
#            title = "Compare whether only did one shift",
#            legend.title = "", legend.labs = levels(factor(model_data$only_one_shift)))  

```

```{r km_top_assignments, fig.width= 8, fig.height = 6}
# top assignments:
top_assign <- names(sort(table(final_data_filt$primary_type),decreasing = T))[1:3]
model_data <- filter(final_data_filt, total_shifts > 0, test_period == "2018",
                     primary_type %in% top_assign)

surv.model <- Surv(model_data$time_last_to_first, model_data$event)
surv.fit <- survfit(surv.model ~ primary_type, data = model_data)

g <- ggsurvplot(surv.fit, data = model_data,
           surv.median.line = "hv", 
           pval = TRUE, conf.int = FALSE, cumevents = TRUE,
           palette = brewer.pal(n=9, "Set1"),
           ylab = "Probability that a volunteer remains active after x days", xlab = "Time From First to Last Shift (days)",
           title = "Compare primary assignments, data in 2018",
           legend.title = "", legend.labs = levels(factor(model_data$primary_type)))  
g

png("EngagementProbs_2018.png", width=800, height=600)
g
dev.off()

```

There is a trend that dog volunteers keep volunteering longer than cat care or dog care volunteers. Cat care is at all three sites, dog care only at Grays Ferry, and dog walking is either PAC or NE. 

We previously saw a bigger difference in 2017 data than here in early 2018 data.

The median volunteer engangement time was not reached.

```{r kaplan-meier-location, fig.width=8, fig.height=6}
model_data <- filter(final_data_filt, total_shifts > 1, test_period == "2018")
surv.model <- Surv(model_data$time_last_to_first, model_data$event)
surv.fit <- survfit(surv.model ~ orient_loc.Primary, data = model_data)

ggsurvplot(surv.fit, data = model_data,
           surv.median.line = "hv", 
           pval = TRUE, conf.int = FALSE, cumevents = TRUE,
           palette = brewer.pal(n=9, "Set1"),
           ylab = "Volunteer Engagement Prob", xlab = "Time From First to Last Shift (days)",
           title = "Compare primary orientation location, data in 2018",
           legend.title = "", legend.labs = levels(factor(model_data$orient_loc.Primary))) 
```



```{r kaplan-meier-orient-location, fig.width=8, fig.height=6}
model_data <- filter(final_data_filt, total_shifts > 0, test_period == "2018")
surv.model <- Surv(model_data$time_last_to_first, model_data$event)
surv.fit <- survfit(surv.model ~ city_clean, data = model_data)

ggsurvplot(surv.fit, data = model_data,
           surv.median.line = "hv", 
           pval = TRUE, conf.int = FALSE, cumevents = TRUE,
           palette = brewer.pal(n=9, "Set1"),
           ylab = "Volunteer Engagement Prob", xlab = "Time From First to Last Shift (days)",
           title = "Compare volunteer residence city, data in 2018",
           legend.title = "", legend.labs = levels(factor(model_data$city_clean))) 
```

Unlike what we observed previously in the previous report, we observe in 2018 data that living outside Philadelphia may mean volunteers become disengaged earlier.
Because this could be affected by volunteering sites/events, this may take additional data mining to learn more about volunteers living outside Philadelphia.

# Conclusions from this part

The additional data is helpful to see what trends we previously observed in the first report are still true! The major take-aways are that:

* More volunteers did orientation during the same period in 2018 compared to 2017
* We continue to see some volunteers that only volunteer once or not at all
* We have not identified any smoking gun for why a volunteer stops volunteering. We did examine factors like how quickly they started volunteering, how often they volunteer, what type of assignments they do, where they volunteer, and where they are from.
